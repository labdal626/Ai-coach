<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Self Coach - Mood & Breath</title>

<!-- Google Font & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    font-family: 'Montserrat', sans-serif;
    color: #f0f0f5;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #app {
    background: rgba(20, 20, 30, 0.85);
    border-radius: 25px;
    width: 420px;
    max-width: 95vw;
    padding: 30px 40px;
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    font-weight: 700;
    margin: 0 0 20px 0;
    font-size: 1.8rem;
    text-align: center;
    letter-spacing: 0.05em;
  }

  #video {
    border-radius: 18px;
    width: 320px;
    height: 240px;
    background: #222;
    border: 3px solid #667eea;
    box-shadow: 0 0 20px #a29bfe;
  }

  #status {
    margin: 18px 0 24px 0;
    font-size: 1.2rem;
    font-weight: 500;
    height: 2em;
    text-align: center;
    min-height: 2em;
  }

  button, #log-clear {
    background: linear-gradient(90deg, #764ba2, #667eea);
    border: none;
    padding: 14px 26px;
    border-radius: 30px;
    color: #f0f0f5;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(118, 75, 162, 0.5);
    margin-top: 10px;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  button:hover, #log-clear:hover {
    background: linear-gradient(90deg, #667eea, #764ba2);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.8);
  }

  #log-clear {
    background: #e74c3c;
    box-shadow: 0 8px 20px rgba(231, 76, 60, 0.5);
    margin-top: 20px;
    font-size: 0.9rem;
  }
  #log-clear:hover {
    background: #c0392b;
    box-shadow: 0 10px 25px rgba(192, 57, 43, 0.8);
  }

  #log {
    margin-top: 20px;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    color: #ccc;
    font-family: monospace;
    font-size: 0.85rem;
    border: 1px solid #555;
    border-radius: 12px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
  }

  @media (max-width: 480px) {
    #video {
      width: 100%;
      height: auto;
    }
    #app {
      padding: 20px;
      width: 95vw;
    }
  }
</style>

</head>
<body>

<div id="app" role="main" aria-label="Virtual Self Coach aplikasi deteksi mood dan latihan napas">
  <h1>Virtual Self Coach</h1>
  <video id="video" playsinline autoplay muted aria-live="polite" aria-label="Tampilan webcam"></video>
  <div id="status" aria-live="assertive" aria-atomic="true">Menginisialisasi...</div>
  <button id="start-breath" aria-pressed="false" aria-label="Mulai latihan pernapasan">Mulai Latihan Napas</button>
  <button id="log-clear" aria-label="Bersihkan catatan latihan">Bersihkan Catatan</button>
  <pre id="log" aria-live="polite" aria-atomic="false" aria-label="Catatan latihan harian"></pre>
</div>

<!-- TensorFlow and Face Landmarks Detection -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.7.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.2/dist/face-landmarks-detection.min.js"></script>

<script>

(async () => {

  // Elemen DOM utama
  const video = document.getElementById('video');
  const status = document.getElementById('status');
  const startBreathBtn = document.getElementById('start-breath');
  const logEl = document.getElementById('log');
  const clearLogBtn = document.getElementById('log-clear');

  // Speech Synthesis
  const synth = window.speechSynthesis;

  // Penyimpanan IndexedDB menggunakan localforage (bisa gunakan localStorage juga)
  // Karena no backend, kita simpan di localStorage sederhana sebagai demo
  const STORAGE_KEY = 'virtual-self-coach-logs';

  // Fungsi baca log latihan dari storage
  function loadLogs() {
    try {
      const json = localStorage.getItem(STORAGE_KEY);
      if (!json) return [];
      return JSON.parse(json);
    } catch {
      return [];
    }
  }

  // Fungsi simpan log latihan ke storage
  function saveLogs(logs) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
  }

  // Fungsi tambah log
  function addLog(text) {
    const logs = loadLogs();
    const timestamp = new Date().toLocaleString('id-ID', {dateStyle:'short', timeStyle:'short'});
    logs.unshift(`${timestamp} - ${text}`);
    saveLogs(logs);
    renderLogs();
  }

  // Render ke elemen log
  function renderLogs() {
    const logs = loadLogs();
    if (logs.length === 0) {
      logEl.textContent = 'Belum ada catatan latihan.';
    } else {
      logEl.textContent = logs.join('\n');
    }
  }

  clearLogBtn.addEventListener('click', () => {
    if (confirm('Yakin ingin menghapus semua catatan latihan?')) {
      localStorage.removeItem(STORAGE_KEY);
      renderLogs();
      speak("Catatan latihan telah dihapus.");
    }
  });

  // Fungsi speak dengan safety check
  function speak(text) {
    if (synth.speaking) {
      synth.cancel();
    }
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'id-ID';
    synth.speak(utter);
  }

  // === Face mood detection setup ===
  let model;

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}});
      video.srcObject = stream;
      status.textContent = 'Kamera aktif, memuat model AI...';
      model = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh);
      status.textContent = 'Model AI siap, mendeteksi mood...';
      detectMood();
    } catch (e) {
      status.textContent = `Error akses kamera: ${e.message}`;
      console.error(e);
    }
  }

  async function detectMood() {
    if (!model) return;
    try {
      const predictions = await model.estimateFaces({input: video, returnTensors: false, flipHorizontal: true});
      if (predictions.length > 0) {
        const keypoints = predictions[0].scaledMesh;

        // Deteksi sederhana mood berdasar jarak bibir terbuka (mulut)
        const topLip = keypoints[13];
        const bottomLip = keypoints[14];
        const mouthOpen = bottomLip[1] - topLip[1];

        // Deteksi ekspresi lain seperti mata lelah bisa ditambahkan
        let moodText = '';
        if (mouthOpen > 18) {
          moodText = 'Mood terdeteksi: Stress/Tegang. Yuk tarik napas dalam-dalam.';
        } else {
          moodText = 'Mood terdeteksi: Tenang dan rileks.';
        }
        status.textContent = moodText;
      } else {
        status.textContent = 'Mood: Wajah tidak terdeteksi, silakan pastikan kamera aktif.';
      }
    } catch (e) {
      console.warn('Detect mood error:', e);
    }
    requestAnimationFrame(detectMood);
  }

  // === Latihan pernapasan interaktif ===
  let breathing = false;

  startBreathBtn.addEventListener('click', () => {
    if (breathing) {
      breathing = false;
      speak('Latihan napas dihentikan.');
      startBreathBtn.textContent = 'Mulai Latihan Napas';
      startBreathBtn.setAttribute('aria-pressed', 'false');
      addLog('Latihan napas dihentikan oleh pengguna.');
      return;
    }
    breathing = true;
    startBreathBtn.textContent = 'Hentikan Latihan Napas';
    startBreathBtn.setAttribute('aria-pressed', 'true');
    runBreathingExercise();
  });

  async function runBreathingExercise() {
    speak("Ayo latihan napas! Tarik napas dalam-dalam... hembuskan perlahan...");
    addLog('Latihan napas dimulai.');

    while (breathing) {
      await slowBreathInOut();
    }
    addLog('Latihan napas selesai.');
  }

  function slowBreathInOut() {
    return new Promise((resolve) => {
      speak("Tarik napas...");
      setTimeout(() => {
        speak("Hembuskan napas...");
        setTimeout(resolve, 5000); // durasi 'hembuskan napas' 5 detik
      }, 4000); // durasi 'tarik napas' 4 detik
    });
  }

  // === Inisialisasi aplikasi ===
  function init() {
    renderLogs();
    startCamera();
    speak("Selamat datang di Virtual Self Coach. Pastikan kamera aktif untuk deteksi mood.");
  }

  // Minta izin notifikasi (optional)
  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        new Notification('Virtual Self Coach siap membantu kamu hari ini!');
      }
    });
  }

  init();

})();
</script>

</body>
</html>
